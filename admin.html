<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Intern Management</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>

<body>

    <div class="main-layout">
        <aside class="sidebar">
            <div style="display: flex; justify-content: center; margin-bottom: 3.5rem;">
                <img src="logo.png" alt="Thiranex" style="height: 65px; object-fit: contain;">
            </div>

            <nav style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button class="btn btn-primary" style="width: 100%; justify-content: flex-start;"
                    onclick="switchTab('overview')">
                    <i class="ph ph-squares-four"></i> <span class="hide-tablet">Overview</span>
                </button>
                <button class="btn"
                    style="width: 100%; justify-content: flex-start; background: transparent; color: var(--text-main);"
                    onclick="switchTab('interns')">
                    <i class="ph ph-users"></i> <span class="hide-tablet">Interns</span>
                </button>
                <button class="btn"
                    style="width: 100%; justify-content: flex-start; background: transparent; color: var(--text-main);"
                    onclick="switchTab('approvals')">
                    <i class="ph ph-check-square"></i> <span class="hide-tablet">Task Approvals</span>
                </button>
                <button class="btn"
                    style="width: 100%; justify-content: flex-start; background: transparent; color: var(--text-main);"
                    onclick="switchTab('payments')">
                    <i class="ph ph-receipt"></i> <span class="hide-tablet">Payments</span>
                </button>
                <button class="btn"
                    style="width: 100%; justify-content: flex-start; background: transparent; color: var(--text-main);"
                    onclick="switchTab('settings')">
                    <i class="ph ph-gear"></i> <span class="hide-tablet">Settings</span>
                </button>
                <button class="btn"
                    style="width: 100%; justify-content: flex-start; background: transparent; color: var(--text-main);"
                    onclick="switchTab('domains')">
                    <i class="ph ph-stack"></i> <span class="hide-tablet">Manage Domains</span>
                </button>
            </nav>

            <button class="btn"
                style="width: 100%; margin-top: 2rem; justify-content: flex-start; background: #FEE2E2; color: #991B1B;"
                onclick="DB.logout()">
                <i class="ph ph-sign-out"></i> <span class="hide-mobile">Logout</span>
            </button>
        </aside>

        <main class="content-area">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1 id="tabTitle">Dashboard Overview</h1>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-weight: 600;">Admin User</span>
                    <div
                        style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary-dark); font-weight: bold;">
                        A</div>
                </div>
            </header>

            <!-- Overview Section -->
            <div id="overview" class="tab-content transition: all 0.3s;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                    <div class="card" style="border-left: 5px solid var(--primary);">
                        <p class="text-muted">Total Active Interns (Learning)</p>
                        <h2 id="countActiveInterns">0</h2>
                    </div>
                    <div class="card" style="border-left: 5px solid #10B981;">
                        <p class="text-muted">Certified Graduates</p>
                        <h2 id="countCertifiedInterns">0</h2>
                    </div>
                    <div class="card" style="border-left: 5px solid var(--success);">
                        <p class="text-muted">Total Revenue Generated</p>
                        <h2 id="totalRevenue" style="color: var(--success);">₹ 0</h2>
                    </div>
                    <div class="card" style="border-left: 5px solid #F97316;">
                        <p class="text-muted">Pending Revenue</p>
                        <h2 id="pendingRevenueDisplay" style="color: #F97316;">₹ 0</h2>
                    </div>

                    <div class="card" style="border-left: 5px solid var(--warning);">
                        <p class="text-muted">Task Approval Requests</p>
                        <h2 id="countPendingTasks" style="color: var(--warning);">0</h2>
                    </div>
                    <div class="card" style="border-left: 5px solid var(--primary);">
                        <p class="text-muted">Payment Verification Requests</p>
                        <h2 id="countPendingPayments" style="color: var(--primary);">0</h2>
                    </div>
                    <div class="card" style="border-left: 5px solid #8B5CF6;">
                        <p class="text-muted">Certificate Requests</p>
                        <h2 id="countPendingCerts" style="color: #8B5CF6;">0</h2>
                    </div>
                </div>
            </div>

            <!-- Interns Section -->
            <div id="interns" class="tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                    <h3>Manage Interns</h3>
                    <button class="btn btn-primary" onclick="openModal('internModal')">Add Intern</button>
                </div>

                <div class="filter-bar" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <div style="flex: 2; min-width: 250px;">
                        <input type="text" id="internSearch" class="form-input"
                            placeholder="Search Name, ID, or Mobile..." oninput="renderInterns()">
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <select id="internSort" class="form-input" onchange="renderInterns()">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="az">Name: A to Z</option>
                            <option value="za">Name: Z to A</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <select id="internFilterStatus" class="form-input" onchange="renderInterns()">
                            <option value="active">Active (Learning)</option>
                            <option value="certified">Certified (Graduated)</option>
                            <option value="dropped">Dropped</option>
                            <option value="all">All Interns</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <select id="internFilterDomain" class="form-input" onchange="renderInterns()">
                            <option value="">All Domains</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <select id="internFilterBatch" class="form-input" onchange="renderInterns()">
                            <option value="">All Batches</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                </div>
                <div class="table-wrapper" style="width: 100%; overflow-x: auto;">
                    <table style="min-width: 1200px;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Domain/Batch</th>
                                <th>Tasks</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Contact</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="internTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Approvals Section -->
            <div id="approvals" class="tab-content" style="display: none;">
                <h3>Pending Task Submissions</h3>
                <div id="approvalsPlaceholder" style="margin-top: 1rem;"></div>
            </div>

            <!-- Payments Section -->
            <div id="payments" class="tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                    <h3>Verify Student Payments</h3>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Ref ID</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="paymentTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="tab-content" style="display: none;">
                <div class="card" style="max-width: 600px; margin: 0 auto; padding: 2rem;">
                    <h3>Portal Payment Settings</h3>
                    <p style="color: var(--text-muted); margin-bottom: 2rem;">These details will be shown to students on
                        their
                        payment page.</p>

                    <form id="settingsForm">
                        <div class="form-group">
                            <label>Display Payment Method to Student</label>
                            <select id="sPreferredMethod" class="form-input" required>
                                <option value="upi">UPI QR Code Only</option>
                                <option value="bank">Bank Account Details Only</option>
                                <option value="both">Show Both</option>
                            </select>
                        </div>

                        <h4 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--primary);">UPI Details</h4>
                        <div class="form-group">
                            <label>Payment Receiver Name</label>
                            <input type="text" id="sAccountName" class="form-input" required
                                placeholder="e.g. Thiranex IT Solutions">
                        </div>
                        <div class="form-group">
                            <label>UPI ID (VPA)</label>
                            <input type="text" id="sUpiId" class="form-input" required placeholder="e.g. thiranex@upi">
                        </div>

                        <h4 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--primary);">Bank Account Details
                        </h4>
                        <div class="form-row" style="display: flex; gap: 1rem;">
                            <div class="form-group" style="flex: 1.5;">
                                <label>Bank Name</label>
                                <input type="text" id="sBankName" class="form-input" required
                                    placeholder="e.g. HDFC Bank">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>IFSC Code</label>
                                <input type="text" id="sIfsc" class="form-input" required placeholder="HDFC0000123">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Account Number</label>
                            <input type="text" id="sAccountNumber" class="form-input" required
                                placeholder="123456789012">
                        </div>

                        <button type="submit" class="btn btn-primary"
                            style="width: 100%; justify-content: center; margin-top: 1rem;">
                            <i class="ph ph-floppy-disk"></i> Save Settings
                        </button>
                    </form>
                </div>
            </div>

            <!-- Manage Domains Section -->
            <div id="domains" class="tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                    <h3>Manage Internship Domains</h3>
                    <button class="btn btn-primary" onclick="openModal('domainModal')">
                        <i class="ph ph-plus"></i> Add New Domain
                    </button>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Domain Name</th>
                                <th>Total Tasks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="domainTableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Domain Modal -->
    <div id="domainModal" class="modal-overlay">
        <div class="modal" style="max-width: 700px;">
            <h2 id="domainModalTitle">Add New Domain</h2>
            <form id="domainForm" style="margin-top: 1.5rem;">
                <div class="form-group">
                    <label>Domain Name</label>
                    <input type="text" id="domainName" class="form-input" placeholder="e.g. Web Development" required>
                </div>

                <h4 style="margin: 1.5rem 0 1rem; color: var(--primary);">Tasks for this Domain</h4>
                <div id="tasksContainer">
                    <!-- Tasks will be added here dynamically -->
                </div>

                <button type="button" class="btn" onclick="addTaskField()"
                    style="margin-top: 1rem; background: var(--primary-light); color: var(--primary);">
                    <i class="ph ph-plus"></i> Add Task
                </button>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="closeModal('domainModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Domain</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modals -->
    <div id="internModal" class="modal-overlay">
        <div class="modal">
            <h2>Add New Intern</h2>
            <form id="addInternForm" style="margin-top: 1.5rem;">
                <div class="form-group">
                    <div class="form-group">
                        <label>Intern ID (Auto-Generated)</label>
                        <input type="text" id="iId" class="form-input" placeholder="Generated automatically..." readonly
                            style="background: #f1f5f9; cursor: not-allowed; color: var(--text-muted);">
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="iName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="iEmail" class="form-input" required>
                    </div>
                    <div class="form-row" style="display: flex; gap: 1rem;">
                        <div class="form-group" style="flex: 1;">
                            <label>Mobile</label>
                            <input type="tel" id="iMobile" class="form-input" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Domain</label>
                            <select id="iDomain" class="form-input" required>
                                <option>Web Development</option>
                                <option>Data Science</option>
                                <option>UI/UX Design</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" style="display: flex; gap: 1rem;">
                        <div class="form-group" style="flex: 1;">
                            <label>Batch Month</label>
                            <select id="iMonth" class="form-input" required>
                                <option value="Jan">January</option>
                                <option value="Feb">February</option>
                                <option value="Mar">March</option>
                                <option value="Apr">April</option>
                                <option value="May">May</option>
                                <option value="Jun">June</option>
                                <option value="Jul">July</option>
                                <option value="Aug">August</option>
                                <option value="Sep">September</option>
                                <option value="Oct">October</option>
                                <option value="Nov">November</option>
                                <option value="Dec">December</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Batch Year</label>
                            <select id="iYear" class="form-input" required onchange="generateInternId()">
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                            </select>
                        </div>
                    </div> <!-- END Batch Row -->

                    <div class="form-row" style="display: flex; gap: 1rem;">
                        <div class="form-group" style="flex: 1;">
                            <label>Fee Amount (₹)</label>
                            <input type="number" id="iAmount" class="form-input" placeholder="e.g. 1500" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Offer Letter Link (Optional)</label>
                        <input type="url" id="iOffer" class="form-input"
                            placeholder="https://drive.google.com/offer-letter">
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                        <button type="button" class="btn" onclick="closeModal('internModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Intern</button>
                    </div>
            </form>
        </div>
    </div>

    <script src="db.js"></script>
    <script>
        const admin = DB.getCurrentUser();
        if (!admin || admin.role !== 'admin') window.location.href = 'index.html';

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            document.getElementById('tabTitle').innerText = tabId === 'overview' ? 'Dashboard Overview' : tabId.charAt(0).toUpperCase() + tabId.slice(1);

            // Sidebar buttons styling
            document.querySelectorAll('.sidebar .btn').forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(`'${tabId}'`)) {
                    btn.classList.add('btn-primary');
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'white';
                } else {
                    btn.classList.remove('btn-primary');
                    btn.style.background = 'transparent';
                    btn.style.color = 'var(--text-main)';
                }
            });

            if (tabId === 'overview') renderStats();
            if (tabId === 'interns') renderInterns();
            if (tabId === 'approvals') renderApprovals();
            if (tabId === 'payments') renderPayments();
            if (tabId === 'settings') renderSettings();
            if (tabId === 'domains') renderDomains();
            renderStats();
        }

        function renderSettings() {
            const settings = DB.getSettings();
            document.getElementById('sPreferredMethod').value = settings.preferredMethod || 'upi';
            document.getElementById('sUpiId').value = settings.upiId;
            document.getElementById('sAccountName').value = settings.accountName;
            document.getElementById('sBankName').value = settings.bankName;
            document.getElementById('sIfsc').value = settings.ifsc;
            document.getElementById('sAccountNumber').value = settings.accountNumber;
        }

        document.getElementById('settingsForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const data = {
                preferredMethod: document.getElementById('sPreferredMethod').value,
                upiId: document.getElementById('sUpiId').value,
                accountName: document.getElementById('sAccountName').value,
                bankName: document.getElementById('sBankName').value,
                ifsc: document.getElementById('sIfsc').value,
                accountNumber: document.getElementById('sAccountNumber').value
            };
            DB.updateSettings(data);
            alert('Payment settings updated successfully!');
        });

        function renderStats() {
            const stats = DB.getInternStats();
            const interns = DB.get('interns');
            // Filter out dropped interns from calculations
            const activeInternList = interns.filter(i => i.status !== 'dropped');

            // Calculate certified vs active
            const certifiedCount = activeInternList.filter(i => i.certificateUrl).length;
            const learningCount = activeInternList.length - certifiedCount;

            const submissions = DB.get('submissions');

            document.getElementById('countActiveInterns').innerText = learningCount;
            document.getElementById('countCertifiedInterns').innerText = certifiedCount;
            document.getElementById('totalRevenue').innerText = '₹ ' + stats.totalRevenue.toLocaleString();

            // Calculate Pending Revenue (Unpaid Active Interns)
            // Excludes 'verified' (paid) and 'pending' (waiting for verification)
            const unpaidRevenue = activeInternList
                .filter(i => i.paymentStatus !== 'verified' && i.paymentStatus !== 'pending')
                .reduce((sum, i) => sum + (parseFloat(i.feeAmount) || 0), 0);

            const pendingRevenueDisplay = document.getElementById('pendingRevenueDisplay');
            if (pendingRevenueDisplay) pendingRevenueDisplay.innerText = '₹ ' + unpaidRevenue.toLocaleString();


            const pendingPayments = activeInternList.filter(i => i.paymentStatus === 'pending').length;
            const pendingTasks = submissions.filter(s => {
                const intern = interns.find(i => String(i.id) === String(s.internId));
                return s.status === 'pending' && intern && intern.status !== 'dropped';
            }).length;

            document.getElementById('countPendingTasks').innerText = pendingTasks;
            document.getElementById('countPendingPayments').innerText = pendingPayments;
            document.getElementById('countPendingCerts').innerText = stats.pendingCerts;
        }

        let isFilterInitialized = false;

        function formatBatchDate(dateStr) {
            if (!dateStr) return '';
            // If it looks like an ISO string (e.g. 2024-12-31T...), format it
            if (dateStr.includes('T') || dateStr.includes('-')) {
                const d = new Date(dateStr);
                if (!isNaN(d.getTime())) {
                    return d.toLocaleString('default', { month: 'short', year: 'numeric' });
                }
            }
            return dateStr;
        }

        function renderInterns() {
            let interns = DB.get('interns');

            // --- Dynamic Filter Population ---
            const domainSelect = document.getElementById('internFilterDomain');
            const batchSelect = document.getElementById('internFilterBatch');
            const currentDomain = domainSelect.value;
            const currentBatch = batchSelect.value;

            // Clear options (keep first 'All')
            while (domainSelect.options.length > 1) domainSelect.remove(1);
            while (batchSelect.options.length > 1) batchSelect.remove(1);

            // Populate Domains
            const domains = DB.getDomains();
            Object.keys(domains).forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.innerText = d;
                domainSelect.appendChild(opt);
            });
            domainSelect.value = currentDomain;

            // Populate Batches (Chronological Sort)
            // Populate Batches (Chronological Sort)
            // Normalize all batches to their formatted display strings
            const rawBatches = interns.map(i => formatBatchDate(i.batch)).filter(b => b);
            const batches = [...new Set(rawBatches)]; // Unique formatted dates

            batches.sort((a, b) => {
                // Try parsing as date "Mon YYYY"
                const da = new Date(a);
                const db = new Date(b);
                if (!isNaN(da) && !isNaN(db)) return da - db;
                return a.localeCompare(b);
            });

            batches.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.innerText = b;
                batchSelect.appendChild(opt);
            });
            // Restore selection if valid
            if ([...batchSelect.options].some(o => o.value === currentBatch)) {
                batchSelect.value = currentBatch;
            }

            // --- Read Filter Values ---
            const search = document.getElementById('internSearch').value.toLowerCase().trim();
            const sort = document.getElementById('internSort').value;
            const filterStatus = document.getElementById('internFilterStatus').value;
            const filterDomain = document.getElementById('internFilterDomain').value;
            const filterBatch = document.getElementById('internFilterBatch').value;

            // --- Filtering Logic ---
            interns = interns.filter(i => {
                const matchSearch = !search ||
                    i.name.toLowerCase().includes(search) ||
                    String(i.id).toLowerCase().includes(search) ||
                    String(i.mobile).includes(search);

                let matchStatus = true;
                if (filterStatus === 'active') {
                    // Active = Not dropped AND Not certified
                    matchStatus = i.status !== 'dropped' && !i.certificateUrl;
                } else if (filterStatus === 'certified') {
                    // Certified = Not dropped AND Has certificate (assumption: dropped people don't count as certified grads usually, or maybe they do? let's assume valid grads are not dropped)
                    matchStatus = i.status !== 'dropped' && i.certificateUrl;
                } else if (filterStatus === 'dropped') {
                    matchStatus = i.status === 'dropped';
                }

                const matchDomain = !filterDomain || i.domain === filterDomain;
                const matchBatch = !filterBatch || formatBatchDate(i.batch) === filterBatch;

                return matchSearch && matchStatus && matchDomain && matchBatch;
            });

            // --- Sorting Logic ---
            if (sort === 'az') {
                interns.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sort === 'za') {
                interns.sort((a, b) => b.name.localeCompare(a.name));
            } else if (sort === 'oldest') {
                // Keep original order (oldest first)
            } else {
                // Newest First (default, assumes newly added are at the end, so reverse)
                // If there's a timestamp we could use that, but array order is implicit
                interns.reverse();
            }

            // --- Render ---
            const body = document.getElementById('internTableBody');

            if (interns.length === 0) {
                body.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">No interns found matching your criteria.</td></tr>';
                return;
            }

            body.innerHTML = interns.map(i => {
                const tasks = DB.getInternTasks(i.id, i.domain);
                const completed = tasks.filter(t => t.status === 'approved').length;
                const pending = tasks.length - completed; // Show remaining tasks as 'Wait'

                let payBadge = '';
                if (i.paymentStatus === 'verified') payBadge = '<span class="badge badge-success">Paid</span>';
                else if (i.paymentStatus === 'pending') payBadge = '<span class="badge badge-warning">Review</span>';
                else payBadge = '<span class="badge badge-danger">Unpaid</span>';

                let statusColor = i.status === 'dropped' ? '#94A3B8' : 'inherit';
                let rowStyle = `color: ${statusColor};`;

                // Highlight if active intern has no offer letter
                if (i.status !== 'dropped' && !i.offerLetterUrl) {
                    rowStyle += 'background: #FFF7ED; border-left: 4px solid var(--warning);';
                }

                return `
                <tr style="${rowStyle}">
                    <td><strong>${i.id}</strong>${!i.offerLetterUrl && i.status !== 'dropped' ? '<br><small style="color: var(--warning); font-weight: 600;">⚠ Offer Pending</small>' : ''}</td>
                    <td><strong>${i.name}</strong><br><small>${i.email}</small></td>
                    <td><span class="badge badge-primary">${i.domain}</span><br><small>${formatBatchDate(i.batch)}</small></td>
                    <td>
                        <span class="badge badge-success">${completed} Done</span>
                        <span class="badge badge-warning">${pending} Wait</span>
                    </td>
                    <td><strong style="color: var(--primary);">₹${i.feeAmount || 0}</strong></td>
                    <td>${payBadge}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <a href="https://wa.me/91${i.mobile}" target="_blank" class="btn" style="padding: 0.4rem; background: #25D366; color: white;"><i class="ph-fill ph-whatsapp-logo"></i></a>
                            <a href="tel:${i.mobile}" class="btn" style="padding: 0.4rem; background: #3B82F6; color: white;"><i class="ph-fill ph-phone"></i></a>
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <div class="action-dropdown">
                            <button class="dots-btn" onclick="toggleActionMenu(event, '${i.id}')">
                                <i class="ph ph-dots-three-outline-vertical"></i>
                            </button>
                            <div class="action-menu" id="menu-${i.id}" onclick="event.stopPropagation()">
                                <button class="action-item" onclick="addCertificate('${i.id}')">
                                    <i class="ph ph-certificate"></i> ${i.certificateUrl ? 'Update Certificate' : 'Add Certificate'}
                                </button>
                                <button class="action-item" onclick="updateOfferLetter('${i.id}')">
                                    <i class="ph ph-file-text"></i> ${i.offerLetterUrl ? 'Update Offer Letter' : 'Add Offer Letter'}
                                </button>
                                <button class="action-item" onclick="editFee('${i.id}', ${i.feeAmount || 0})">
                                    <i class="ph ph-currency-inr"></i> Edit Fee Amount
                                </button>
                                <button class="action-item" onclick="markDropped('${i.id}')">
                                    <i class="ph ph-user-minus"></i> Mark Dropped
                                </button>
                                <hr style="border: none; border-top: 1px solid var(--border); margin: 0.2rem 0;">
                                <button class="action-item danger" onclick="deleteIntern('${i.id}')">
                                    <i class="ph ph-trash"></i> Delete Intern
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function toggleActionMenu(e, id) {
            e.stopPropagation();
            const menu = document.getElementById(`menu-${id}`);
            const btn = e.currentTarget;

            // Close all other menus
            document.querySelectorAll('.action-menu').forEach(m => {
                if (m.id !== `menu-${id}`) m.classList.remove('show');
            });
            document.querySelectorAll('.dots-btn').forEach(b => {
                if (b !== btn) b.classList.remove('active');
            });

            menu.classList.toggle('show');
            btn.classList.toggle('active');
        }

        // Close dropdowns on outside click
        window.addEventListener('click', () => {
            document.querySelectorAll('.action-menu').forEach(m => m.classList.remove('show'));
            document.querySelectorAll('.dots-btn').forEach(b => b.classList.remove('active'));
        });

        function addCertificate(id) {
            const url = prompt('Enter Certificate Link (PDF/URL):');
            if (url) {
                DB.updateIntern(id, {
                    certificateUrl: url,
                    certRequestStatus: 'issued'
                });
                renderInterns();
                if (document.getElementById('approvals').style.display !== 'none') {
                    renderApprovals();
                }
                renderStats();
                alert('Certificate issued successfully!');
            }
        }

        function updateOfferLetter(id) {
            const url = prompt('Enter Offer Letter Link (PDF/URL):');
            if (url) {
                DB.updateIntern(id, { offerLetterUrl: url });
                renderInterns();
                alert('Offer Letter link updated successfully!');
            }
        }

        function editFee(id, currentAmount) {
            const newAmount = prompt('Enter new Fee Amount (₹):', currentAmount);
            if (newAmount !== null) {
                const amount = parseFloat(newAmount);
                if (!isNaN(amount)) {
                    DB.updateIntern(id, { feeAmount: amount });
                    renderInterns();
                    renderStats();
                    alert('Fee amount updated successfully!');
                } else {
                    alert('Please enter a valid number.');
                }
            }
        }

        function markDropped(id) {
            if (confirm('Mark this intern as Dropped Out?')) {
                DB.updateIntern(id, { status: 'dropped' });
                renderInterns();
                renderStats();
            }
        }

        function renderPayments() {
            let interns = DB.get('interns').filter(i => i.paymentStatus !== 'unpaid');
            const body = document.getElementById('paymentTableBody');

            // Sort: Pending first, then by timestamp (newest first)
            interns.sort((a, b) => {
                if (a.paymentStatus === 'pending' && b.paymentStatus !== 'pending') return -1;
                if (a.paymentStatus !== 'pending' && b.paymentStatus === 'pending') return 1;

                // If same status, sort by newest time
                const timeA = new Date(a.paymentTimestamp || 0).getTime();
                const timeB = new Date(b.paymentTimestamp || 0).getTime();
                return timeB - timeA;
            });

            if (interns.length === 0) {
                body.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted)">No payment history found.</td></tr>';
                return;
            }

            body.innerHTML = interns.map(i => {
                let statusBadge = '';
                let actions = '';

                if (i.paymentStatus === 'verified') {
                    statusBadge = '<span class="badge badge-success">Verified</span>';
                    actions = '<span style="color: var(--success); font-size: 0.8rem;"><i class="ph-fill ph-check-circle"></i> Verification Done</span>';
                } else if (i.paymentStatus === 'rejected') {
                    statusBadge = '<span class="badge badge-danger">Rejected</span>';
                    actions = `<button class="btn" style="background: #DCFCE7; color: #166534; padding: 0.4rem 0.8rem;" onclick="verifyPayment('${i.id}', 'verified')">Re-verify & Approve</button>`;
                } else {
                    statusBadge = '<span class="badge badge-warning">Pending</span>';
                    actions = `
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" style="background: #FEE2E2; color: #991B1B; padding: 0.4rem 0.8rem;" onclick="verifyPayment('${i.id}', 'rejected')">Reject</button>
                            <button class="btn" style="background: #DCFCE7; color: #166534; padding: 0.4rem 0.8rem;" onclick="verifyPayment('${i.id}', 'verified')">Approve</button>
                        </div>
                    `;
                }

                return `
                    <tr>
                        <td><strong>${i.name}</strong><br><small>${i.domain}</small></td>
                        <td><code>${i.paymentRef}</code></td>
                        <td>₹ ${i.feeAmount || 0}</td>
                        <td>${statusBadge}</td>
                        <td>${actions}</td>
                    </tr>
                `;
            }).join('');
        }

        function verifyPayment(id, status) {
            if (DB.verifyPayment(id, status)) {
                alert(`Payment ${status === 'verified' ? 'approved' : 'rejected'} successfully.`);
                renderPayments();
                renderStats();
            }
        }

        function renderApprovals() {
            const submissions = DB.get('submissions').filter(s => s.status === 'pending');
            const interns = DB.get('interns');
            const certRequests = interns.filter(i => i.certRequestStatus === 'requested');
            const placeholder = document.getElementById('approvalsPlaceholder');

            let html = '';

            // Certificate Requests Section
            if (certRequests.length > 0) {
                html += `
                    <div style="margin-bottom: 2.5rem;">
                        <h4 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; color: #8B5CF6;">
                            <i class="ph ph-certificate"></i> Certificate Requests (${certRequests.length})
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            ${certRequests.map(i => `
                                <div class="card" style="display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #8B5CF6; gap: 1.5rem;">
                                    <div style="flex: 1; min-width: 0;">
                                        <h4 style="margin-bottom: 0.2rem;">${i.name}</h4>
                                        <p class="text-muted" style="font-size: 0.85rem;">Completed: <strong>${i.domain}</strong> | Batch: ${i.batch}</p>
                                    </div>
                                    <div style="flex-shrink: 0;">
                                        <button class="btn" style="background: #EDE9FE; color: #5B21B6;" onclick="addCertificate('${i.id}')">
                                            Issue Certificate
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Task Submissions Section
            html += `
                <h4 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; color: var(--warning);">
                    <i class="ph ph-stack"></i> Task Submissions (${submissions.length})
                </h4>
            `;

            if (submissions.length === 0 && certRequests.length === 0) {
                placeholder.innerHTML = '<div class="card" style="text-align: center; padding: 3rem; color: var(--text-muted);">No pending requests at the moment.</div>';
                return;
            }

            if (submissions.length === 0) {
                html += '<div class="card" style="text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.9rem;">No pending task submissions.</div>';
            } else {
                html += submissions.map(s => {
                    const intern = interns.find(i => String(i.id) === String(s.internId));
                    if (!intern) return '';
                    const taskList = DOMAIN_TASKS[intern.domain];
                    const task = taskList.find(t => String(t.id) === String(s.taskId));
                    return `
                        <div class="card" style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; gap: 1.5rem;">
                            <div style="flex: 1; min-width: 0;">
                                <h4 style="margin-bottom: 0.2rem;">${task.title}</h4>
                                <p class="text-muted" style="font-size: 0.9rem;">Submitted by <strong>${intern.name}</strong> (${intern.domain})</p>
                                <p style="margin-top: 0.5rem;"><a href="${s.proof}" target="_blank" style="color: var(--primary); font-weight: 500;"><i class="ph ph-link"></i> View Submission Link</a></p>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
                                <button class="btn" style="background: #FEE2E2; color: #991B1B;" onclick="rejectTask('${s.internId}', '${s.taskId}')">Reject</button>
                                <button class="btn" style="background: #DCFCE7; color: #166534;" onclick="approveAction('${s.internId}', '${s.taskId}')">Approve & Unlock Next</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            placeholder.innerHTML = html;
        }

        function approveAction(iId, tId) {
            DB.approveTask(iId, tId);
            renderApprovals();
            renderStats();
            alert('Task approved and next task unlocked for the student!');
        }

        function rejectTask(iId, tId) {
            const subs = DB.get('submissions');
            const sub = subs.find(s => String(s.internId) === String(iId) && String(s.taskId) === String(tId));
            if (sub) {
                sub.status = 'rejected';
                DB.set('submissions', subs);
                renderApprovals();
                renderStats();
                alert('Task rejected.');
            }
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
            if (id === 'internModal') {
                // Set default batch values if not already set or verify current date
                const today = new Date();
                const mon = today.toLocaleString('default', { month: 'short' });
                const year = today.getFullYear();

                // If inputs are empty/default, set to current
                if (document.getElementById('iMonth').value === 'Jan') { // Assuming Jan is first
                    document.getElementById('iMonth').value = mon;
                    document.getElementById('iYear').value = year;
                }
                generateInternId();
            }
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // Listen for month change too to regen ID
        document.getElementById('iMonth').addEventListener('change', generateInternId);

        function generateInternId() {
            const month = document.getElementById('iMonth').value.toUpperCase();
            const yearFull = document.getElementById('iYear').value;
            const yearShort = yearFull.slice(-2);

            // Format: THX-MMM-YY-
            const prefix = `THX-${month}${yearShort}-`;

            // Find existing IDs with this prefix to determine the sequence number
            const interns = DB.get('interns');
            let maxSeq = 0;

            interns.forEach(i => {
                if (i.id && i.id.startsWith(prefix)) {
                    const parts = i.id.split('-');
                    if (parts.length === 3) {
                        const seq = parseInt(parts[2]);
                        if (!isNaN(seq) && seq > maxSeq) {
                            maxSeq = seq;
                        }
                    }
                }
            });

            const nextSeq = maxSeq + 1;
            const seqStr = String(nextSeq).padStart(3, '0');

            document.getElementById('iId').value = `${prefix}${seqStr}`;
        }

        document.getElementById('addInternForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const interns = DB.get('interns');
            const newIntern = {
                id: document.getElementById('iId').value,
                name: document.getElementById('iName').value,
                email: document.getElementById('iEmail').value,
                mobile: document.getElementById('iMobile').value,
                domain: document.getElementById('iDomain').value,
                batch: document.getElementById('iMonth').value + ' ' + document.getElementById('iYear').value,
                feeAmount: parseFloat(document.getElementById('iAmount').value) || 0,
                offerLetterUrl: document.getElementById('iOffer').value || '',
                status: 'active',
                paymentStatus: 'unpaid'
            };
            interns.push(newIntern);
            DB.set('interns', interns);
            closeModal('internModal');
            renderInterns();
            renderStats();
            this.reset();
        });

        function deleteIntern(id) {
            if (confirm('Are you sure you want to delete this intern? This action cannot be undone.')) {
                const interns = DB.get('interns').filter(i => String(i.id) !== String(id));
                DB.set('interns', interns);

                // Also clean up their submissions
                const subs = DB.get('submissions').filter(s => String(s.internId) !== String(id));
                DB.set('submissions', subs);

                renderInterns();
                renderStats();
            }
        }

        // Domain Management Functions
        let editingDomain = null;
        let taskCounter = 0;

        function renderDomains() {
            const domains = DB.getDomains();
            const body = document.getElementById('domainTableBody');

            const domainNames = Object.keys(domains);

            if (domainNames.length === 0) {
                body.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 2rem; color: var(--text-muted)">No domains found. Add your first domain!</td></tr>';
                return;
            }

            body.innerHTML = domainNames.map(name => {
                const tasks = domains[name];
                return `
                    <tr>
                        <td><strong>${name}</strong></td>
                        <td><span class="badge badge-primary">${tasks.length} Tasks</span></td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn" style="background: var(--primary-light); color: var(--primary); padding: 0.4rem 0.8rem;" onclick="editDomain('${name}')">
                                    <i class="ph ph-pencil"></i> Edit
                                </button>
                                <button class="btn" style="background: #FEE2E2; color: #991B1B; padding: 0.4rem 0.8rem;" onclick="deleteDomain('${name}')">
                                    <i class="ph ph-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function editDomain(domainName) {
            editingDomain = domainName;
            const domains = DB.getDomains();
            const tasks = domains[domainName];

            document.getElementById('domainModalTitle').innerText = 'Edit Domain';
            document.getElementById('domainName').value = domainName;

            // Clear and populate tasks
            const container = document.getElementById('tasksContainer');
            container.innerHTML = '';
            taskCounter = 0;

            tasks.forEach((task, index) => {
                // Map legacy 'desc' to 'objective' if objective is missing
                const objective = task.objective || task.desc || '';
                addTaskField(task.title, objective, task.feature, task.outcome);
            });

            openModal('domainModal');
        }

        function deleteDomain(domainName) {
            if (confirm(`Are you sure you want to delete the domain "${domainName}"? This will remove all tasks associated with it.`)) {
                DB.deleteDomain(domainName);
                renderDomains();
                updateDomainDropdowns();
                alert('Domain deleted successfully!');
            }
        }

        function addTaskField(title = '', objective = '', feature = '', outcome = '') {
            taskCounter++;
            const container = document.getElementById('tasksContainer');
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-field';
            taskDiv.id = `task-${taskCounter}`;
            taskDiv.style.cssText = 'border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; position: relative; background: #f8fafc;';

            // Process existing features
            // Process existing features (Prioritize newline split to preserve commas in sentences)
            let existingFeatures = [];
            if (feature) {
                const fStr = String(feature);
                // If it contains newlines, it's definitely our new format -> split by newline only
                if (fStr.includes('\n')) {
                    existingFeatures = fStr.split('\n').map(f => f.trim()).filter(f => f);
                }
                // If no newlines but has commas, it might be legacy -> split by comma
                else if (fStr.includes(',')) {
                    existingFeatures = fStr.split(',').map(f => f.trim()).filter(f => f);
                }
                // Single line, no comma
                else {
                    existingFeatures = [fStr.trim()];
                }
            }
            if (existingFeatures.length === 0) existingFeatures = [''];
            if (existingFeatures.length === 0) existingFeatures = [''];

            let featureInputsHtml = existingFeatures.map((feat, i) => `
                <div class="feature-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="text" class="form-input feature-item" placeholder="Add a feature point" value="${feat}" required>
                    ${i > 0 || existingFeatures.length > 1 ? `<button type="button" class="btn" style="padding: 0.4rem; background: #FEE2E2; color: #991B1B;" onclick="this.parentElement.remove()"><i class="ph ph-minus"></i></button>` : ''}
                </div>
            `).join('');

            taskDiv.innerHTML = `
                <button type="button" onclick="removeTaskField('task-${taskCounter}')" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #FEE2E2; color: #991B1B; border: none; border-radius: 4px; padding: 0.3rem 0.5rem; cursor: pointer;">
                    <i class="ph ph-x"></i>
                </button>
                <div class="form-group">
                    <label>Task Title</label>
                    <input type="text" class="form-input task-title" placeholder="e.g. HTML/CSS Basics" value="${title}" required>
                </div>
                <div class="form-group">
                    <label>Objective</label>
                    <textarea class="form-input task-objective" rows="2" placeholder="What is the main goal of this task?" required>${objective}</textarea>
                </div>
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label>Key Features (Bullet Points)</label>
                        <button type="button" class="btn" style="font-size: 0.8rem; padding: 0.2rem 0.6rem; background: var(--primary-light); color: var(--primary);" onclick="addFeatureRow('features-${taskCounter}')">
                            <i class="ph ph-plus"></i> Add Point
                        </button>
                    </div>
                    <div id="features-${taskCounter}">
                        ${featureInputsHtml}
                    </div>
                </div>
                <div class="form-group">
                    <label>Outcome</label>
                    <textarea class="form-input task-outcome" rows="2" placeholder="Expected result or deliverables" required>${outcome}</textarea>
                </div>
            `;

            container.appendChild(taskDiv);
        }

        function addFeatureRow(containerId) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'feature-row';
            div.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            div.innerHTML = `
                <input type="text" class="form-input feature-item" placeholder="Add a feature point" required>
                <button type="button" class="btn" style="padding: 0.4rem; background: #FEE2E2; color: #991B1B;" onclick="this.parentElement.remove()"><i class="ph ph-minus"></i></button>
            `;
            container.appendChild(div);
        }

        function removeTaskField(id) {
            document.getElementById(id).remove();
        }

        function updateDomainDropdowns() {
            const domains = DB.getDomains();
            const domainNames = Object.keys(domains);

            // Update domain dropdown in Add Intern modal
            const domainSelect = document.getElementById('iDomain');
            if (domainSelect) {
                domainSelect.innerHTML = domainNames.map(name =>
                    `<option>${name}</option>`
                ).join('');
            }
        }

        document.getElementById('domainForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const domainName = document.getElementById('domainName').value.trim();
            const taskFields = document.querySelectorAll('.task-field');

            if (taskFields.length === 0) {
                alert('Please add at least one task for this domain.');
                return;
            }

            const tasks = [];
            taskFields.forEach((field, index) => {
                const title = field.querySelector('.task-title').value.trim();
                const objective = field.querySelector('.task-objective').value.trim();

                // Collect all feature inputs
                const featureInputs = field.querySelectorAll('.feature-item');
                const featureList = Array.from(featureInputs).map(i => i.value.trim()).filter(val => val);
                const feature = featureList.join('\n');

                const outcome = field.querySelector('.task-outcome').value.trim();

                if (title && objective) { // Basic validation
                    tasks.push({
                        id: index + 1,
                        title: title,
                        objective: objective,
                        feature: feature,
                        outcome: outcome
                    });
                }
            });

            if (tasks.length === 0) {
                alert('Please fill in all task fields.');
                return;
            }

            if (editingDomain) {
                DB.updateDomain(editingDomain, domainName, tasks);
                alert('Domain updated successfully!');
            } else {
                const domains = DB.getDomains();
                if (domains[domainName]) {
                    alert('A domain with this name already exists. Please choose a different name.');
                    return;
                }
                DB.addDomain(domainName, tasks);
                alert('Domain added successfully!');
            }

            closeModal('domainModal');
            renderDomains();
            updateDomainDropdowns();
            this.reset();
            document.getElementById('tasksContainer').innerHTML = '';
            editingDomain = null;
            taskCounter = 0;
        });

        // Reset modal when opening for new domain
        document.querySelector('[onclick="openModal(\'domainModal\')"]').addEventListener('click', function () {
            editingDomain = null;
            document.getElementById('domainModalTitle').innerText = 'Add New Domain';
            document.getElementById('domainName').value = '';
            document.getElementById('tasksContainer').innerHTML = '';
            taskCounter = 0;
            // Add one empty task field
            addTaskField();
        });

        // Initialize
        (async function initApp() {
            // Show loading state
            const loader = document.createElement('div');
            loader.innerHTML = '<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);z-index:9999;display:flex;justify-content:center;align-items:center;"><h3><i class="ph ph-spinner ph-spin"></i> Syncing with Cloud...</h3></div>';
            document.body.appendChild(loader);

            await DB.initialize();

            updateDomainDropdowns();
            renderStats(); // Ensure stats are fresh
            switchTab('overview');

            document.body.removeChild(loader);
        })();
    </script>
</body>

</html>