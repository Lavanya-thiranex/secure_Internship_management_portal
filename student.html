<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard | Intern Portal</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        .doc-buttons {
            display: flex;
            flex-direction: row;
            gap: 0.8rem;
            justify-content: flex-end;
            align-items: center;
            margin-top: 1.2rem;
        }

        .doc-btn {
            font-size: 0.95rem !important;
            padding: 0.7rem 1.2rem !important;
            min-width: 160px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .doc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-stats {
            text-align: right;
        }

        @media (max-width: 768px) {
            .level-header {
                flex-direction: column;
                text-align: center;
                gap: 2rem;
                padding: 1.5rem !important;
            }

            .header-stats {
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
            }

            .doc-buttons {
                justify-content: center;
                width: 100%;
                flex-wrap: wrap;
            }

            #userName {
                font-size: 1.8rem;
            }
        }

        /* Redesigned Full White ID Card */
        .id-card {
            width: 350px;
            height: 520px;
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #edf2f7;
            margin: 0 auto;
            border-top: 6px solid var(--primary);
        }

        .id-card-header {
            width: 100%;
            height: 100px;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1.5rem 1rem 0.5rem 1rem;
        }

        .id-card-logo {
            height: 55px;
            max-width: 85% !important;
            object-fit: contain;
        }

        .id-card-body {
            padding: 70px 25px 25px 25px;
            text-align: center;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .id-card-avatar {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            background: #f8fafc;
            border: 5px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.8rem;
            color: var(--primary);
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.08);
        }

        .id-card-name {
            font-size: 1.5rem;
            font-weight: 800;
            color: #0f172a;
            margin-top: 5px;
            letter-spacing: -0.5px;
        }

        .id-card-domain {
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 15px;
        }

        .id-card-details {
            text-align: left;
            background: #fdfdfd;
            padding: 1.2rem;
            border-radius: 16px;
            width: 100%;
            border: 1px solid #f1f5f9;
        }

        .id-card-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 0.8rem;
            gap: 0.2rem;
        }

        .id-card-row:last-child {
            margin-bottom: 0;
        }

        .id-card-label {
            color: #94a3b8;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .id-card-value {
            color: #334155;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .id-card-footer {
            margin-top: auto;
            padding-bottom: 25px;
            font-size: 0.7rem;
            color: #cbd5e1;
            font-weight: 500;
            text-align: center;
            letter-spacing: 0.5px;
        }
    </style>
</head>

<body style="padding-bottom: 5rem;">

    <nav
        style="background: white; padding: 1rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100;">
        <div style="display: flex; align-items: center;">
            <img src="logo.png" alt="Thiranex" style="height: 60px; object-fit: contain;">
        </div>

        <!-- Desktop Nav -->
        <div class="nav-links-desktop" style="display: flex; gap: 1rem; align-items: center;">
            <button class="nav-btn active" id="tabTasks" onclick="switchTab('tasks')">
                <i class="ph ph-list-checks"></i> Tasks
            </button>
            <button class="nav-btn" id="tabPayment" onclick="switchTab('payment')">
                <i class="ph ph-receipt"></i> Payment
            </button>
            <button class="nav-btn" onclick="openProfileModal()">
                <i class="ph ph-user-circle"></i> Profile
            </button>
            <button class="nav-btn" id="tabHelp" onclick="switchTab('help')">
                <i class="ph ph-question"></i> Help
            </button>
            <button class="nav-btn" onclick="toggleIDCardModal(true)">
                <i class="ph ph-identification-card"></i> ID Card
            </button>
            <button class="btn" style="background: var(--bg-app); color: var(--text-main);" onclick="DB.logout()">
                <i class="ph ph-sign-out"></i> Logout
            </button>
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
            <i class="ph ph-list"></i>
        </button>
    </nav>

    <!-- Mobile Nav Overlay -->
    <div class="mobile-nav-backdrop" id="menuBackdrop" onclick="toggleMobileMenu()"></div>
    <div class="mobile-nav-overlay" id="mobileMenu">
        <div style="display: flex; justify-content: center; margin-bottom: 2.5rem;">
            <img src="logo.png" alt="Thiranex" style="height: 55px; object-fit: contain;">
        </div>
        <button class="btn" style="justify-content: flex-start; background: transparent;"
            onclick="switchTab('tasks'); toggleMobileMenu();">
            <i class="ph ph-list-checks"></i> Tasks
        </button>
        <button class="btn" style="justify-content: flex-start; background: transparent;"
            onclick="switchTab('payment'); toggleMobileMenu();">
            <i class="ph ph-receipt"></i> Payment
        </button>
        <button class="btn" style="justify-content: flex-start; background: transparent;"
            onclick="openProfileModal(); toggleMobileMenu();">
            <i class="ph ph-user-circle"></i> Profile
        </button>
        <button class="btn" style="justify-content: flex-start; background: transparent;"
            onclick="switchTab('help'); toggleMobileMenu();">
            <i class="ph ph-question"></i> Help
        </button>
        <button class="btn" style="justify-content: flex-start; background: transparent;"
            onclick="toggleIDCardModal(true); toggleMobileMenu();">
            <i class="ph ph-identification-card"></i> ID Card
        </button>
        <hr style="border: none; border-top: 1px solid var(--border);">
        <button class="btn" style="justify-content: flex-start; background: #FEE2E2; color: #991B1B;"
            onclick="DB.logout()">
            <i class="ph ph-sign-out"></i> Logout
        </button>
    </div>

    <div class="container">
        <!-- Dashboard Section -->
        <div id="sectionTasks">
            <!-- Gamified Header -->
            <div class="level-header">
                <div>
                    <p style="text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; color: #94A3B8;">
                        Welcome
                        Intern</p>
                    <h1 id="userName">Loading...</h1>
                    <p id="userDomain" class="badge badge-primary" style="margin-top: 0.5rem;"></p>
                </div>
                <div class="header-stats">
                    <div class="xp-circle" id="userLevel">0%</div>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">Internship Progress</p>
                    <div class="doc-buttons">
                        <!-- Offer Letter Button -->
                        <a id="offerLink" href="#" target="_blank" class="btn doc-btn">
                            Loading...
                        </a>

                        <!-- Certificate Button -->
                        <a id="certLink" href="#" target="_blank" class="btn doc-btn">
                            Loading...
                        </a>
                    </div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
            </div>

            <div style="margin: 2rem 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>Your Journey Tasks</h2>
                    <div id="paymentAlert" style="display: none;">
                        <span class="badge badge-warning" onclick="switchTab('payment')" style="cursor: pointer;">
                            <i class="ph ph-warning-circle"></i> Payment Pending
                        </span>
                    </div>
                </div>
                <div id="certificateRequestArea" style="margin-bottom: 2rem; display: none;"></div>
                <div id="taskList"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">
                    <!-- Tasks will be injected here -->
                </div>
            </div>
        </div>

        <!-- Payment Section -->
        <div id="sectionPayment" style="display: none;">
            <div class="card" style="max-width: 800px; margin: 0 auto; padding: 3rem; text-align: center;">
                <div id="paymentHeader" style="margin-bottom: 2rem;">
                    <h1 style="font-size: 2rem; margin-bottom: 1rem;">Complete Your Enrollment</h1>
                    <p style="color: var(--text-muted);">Please complete the payment to ensure your certificate and
                        internship access are secured.</p>
                </div>

                <div id="paymentInstructions"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: center; text-align: left;">
                    <div id="qrSection">
                        <div
                            style="background: white; padding: 1rem; border-radius: var(--radius-lg); border: 2px dashed var(--primary); display: inline-block;">
                            <img id="dynamicQR" src="qr_code.png" alt="Payment QR Code"
                                style="width: 250px; height: 250px; display: block;">
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted); text-align: center;">
                            <i class="ph ph-scan"></i> Scan this QR using any UPI app
                        </p>
                    </div>
                </div>

                <div id="paymentFormArea">
                    <h3 style="margin-bottom: 1.5rem;">Submit Payment Details</h3>
                    <form id="paymentForm">
                        <div class="form-group">
                            <label>Payment Reference ID (UTR / Transaction ID)</label>
                            <input type="text" id="payRef" class="form-input" placeholder="e.g. 412384759601" required>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Enter the
                                12-digit transaction ID from your UPI app.</p>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                            <i class="ph ph-paper-plane-tilt"></i> Submit Reference ID
                        </button>
                    </form>
                </div>

                <div id="paymentStatusArea"
                    style="display: none; grid-column: span 2; text-align: center; padding: 2rem;">
                    <div id="statusIcon" style="font-size: 4rem; color: var(--warning); margin-bottom: 1rem;">
                        <i class="ph ph-clock-countdown"></i>
                    </div>
                    <h2 id="statusTitle">Verification in Progress</h2>
                    <p id="statusDesc" style="color: var(--text-muted); margin-top: 0.5rem;">
                        Our admin team is verifying your payment (Ref: <span id="displayPayRef"></span>).
                        You will receive a notification once verified.
                    </p>
                    <div id="verifiedBadge" style="display: none; margin-top: 1.5rem;">
                        <span class="badge badge-success" style="font-size: 1rem; padding: 0.5rem 1.5rem;">
                            <i class="ph ph-check-circle"></i> VERIFIED
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div id="sectionHelp" style="display: none;">
            <div class="card" style="max-width: 600px; margin: 2rem auto; text-align: center; padding: 3rem 2rem;">
                <div
                    style="width: 80px; height: 80px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 3rem; margin: 0 auto 1.5rem;">
                    <i class="ph ph-headset"></i>
                </div>
                <h2 style="margin-bottom: 0.5rem;">Help & Support</h2>
                <p class="text-muted" style="margin-bottom: 2.5rem;">Have questions or facing issues? Our team is here
                    to help you 24/7.</p>

                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- WhatsApp (Preferred) -->
                    <a href="https://wa.me/919465241129" target="_blank" class="card"
                        style="display: flex; align-items: center; gap: 1.5rem; text-decoration: none; border: 2px solid #25D366; background: #f0fff4;">
                        <div
                            style="width: 50px; height: 50px; border-radius: 12px; background: #25D366; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; flex-shrink: 0;">
                            <i class="ph-fill ph-whatsapp-logo"></i>
                        </div>
                        <div style="text-align: left;">
                            <h4 style="color: #166534; margin-bottom: 0.2rem;">WhatsApp Support</h4>
                            <p style="color: #15803d; font-size: 0.85rem; font-weight: 600;">(Recommended for Faster
                                Response)</p>
                        </div>
                        <i class="ph ph-caret-right" style="margin-left: auto; color: #166534;"></i>
                    </a>

                    <!-- Direct Call -->
                    <a href="tel:+919465241129" class="card"
                        style="display: flex; align-items: center; gap: 1.5rem; text-decoration: none;">
                        <div
                            style="width: 50px; height: 50px; border-radius: 12px; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; flex-shrink: 0;">
                            <i class="ph ph-phone"></i>
                        </div>
                        <div style="text-align: left;">
                            <h4 style="margin-bottom: 0.2rem;">Call Us</h4>
                            <p class="text-muted" style="font-size: 0.85rem;">+91 94652 41129</p>
                        </div>
                        <i class="ph ph-caret-right" style="margin-left: auto; color: var(--text-muted);"></i>
                    </a>

                    <!-- Email Support -->
                    <a href="mailto:info.thiranex@gmail.com" class="card"
                        style="display: flex; align-items: center; gap: 1.5rem; text-decoration: none;">
                        <div
                            style="width: 50px; height: 50px; border-radius: 12px; background: #FEE2E2; color: #991B1B; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; flex-shrink: 0;">
                            <i class="ph ph-envelope"></i>
                        </div>
                        <div style="text-align: left;">
                            <h4 style="margin-bottom: 0.2rem;">Email Support</h4>
                            <p class="text-muted" style="font-size: 0.85rem;">info.thiranex@gmail.com</p>
                        </div>
                        <i class="ph ph-caret-right" style="margin-left: auto; color: var(--text-muted);"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Submit Modal -->
    <div id="submitModal" class="modal-overlay">
        <div class="modal">
            <h2 id="modalTaskTitle">Submit Task</h2>
            <p id="modalTaskDesc" style="color: var(--text-muted); margin-top: 0.5rem;"></p>

            <form id="submitTaskForm" style="margin-top: 1.5rem;">
                <input type="hidden" id="modalTaskId">
                <div class="form-group">
                    <label>Submission Link (GitHub, Drive, or URL)</label>
                    <input type="url" id="taskProof" class="form-input" placeholder="https://github.com/your-work"
                        required>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit for Review</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Update Modal -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal">
            <h2>Update Profile</h2>
            <p style="color: var(--text-muted); margin-top: 0.5rem;">Update your personal and educational details.
            </p>

            <form id="profileForm" style="margin-top: 1.5rem;">
                <div class="form-row" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label>Intern ID</label>
                        <input type="text" id="pInternId" class="form-input" readonly
                            style="background: #f1f5f9; cursor: not-allowed; color: var(--text-muted);">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Batch</label>
                        <input type="text" id="pBatch" class="form-input" readonly
                            style="background: #f1f5f9; cursor: not-allowed; color: var(--text-muted);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="pName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>College Name</label>
                    <input type="text" id="pCollege" class="form-input" placeholder="Enter your college name">
                </div>
                <div class="form-group">
                    <label>Skills (Comma separated)</label>
                    <input type="text" id="pSkills" class="form-input" placeholder="e.g. Java, Python, Figma">
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" class="btn" onclick="closeProfileModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Reminder Modal -->
    <div id="paymentReminderModal" class="modal-overlay" style="z-index: 2100;">
        <div class="modal" style="text-align: center; max-width: 400px;">
            <div
                style="width: 70px; height: 70px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin: 0 auto 1.5rem;">
                <i class="ph-fill ph-warning-circle"></i>
            </div>
            <h2 id="reminderTitle">Action Required</h2>
            <p id="reminderDesc" style="color: var(--text-muted); margin-bottom: 2rem;">
                Your internship payment is pending verification. Please complete the payment process to unlock all tasks
                and features.
            </p>
            <button class="btn btn-primary" style="width: 100%; justify-content: center; padding: 1rem;"
                onclick="goToPayment()">
                Complete Payment Now
            </button>
            <button class="btn"
                style="width: 100%; justify-content: center; margin-top: 0.5rem; background: transparent; color: var(--text-muted);"
                onclick="closePaymentReminder()">
                Dismiss
            </button>
        </div>
    </div>

    <!-- ID Card Modal -->
    <div id="idCardModal" class="modal-overlay">
        <div class="modal" style="background: transparent; box-shadow: none; padding: 0; width: auto; max-width: 100%;">
            <div id="captureArea">
                <div class="id-card">
                    <div class="id-card-header">
                        <img src="logo.png" alt="Thiranex" class="id-card-logo">
                    </div>
                    <div class="id-card-avatar" id="idAvatar">A</div>
                    <div class="id-card-body">
                        <div class="id-card-name" id="idCardName">Intern Name</div>
                        <div class="id-card-domain" id="idCardDomain">Domain Name</div>

                        <div class="id-card-details">
                            <div class="id-card-row">
                                <span class="id-card-label">Intern ID:</span>
                                <span class="id-card-value" id="idCardInternId">TX-2026-001</span>
                            </div>
                            <div class="id-card-row">
                                <span class="id-card-label">Batch:</span>
                                <span class="id-card-value" id="idCardBatch">Jan 2026</span>
                            </div>
                            <div class="id-card-row">
                                <span class="id-card-label">Status:</span>
                                <span class="id-card-value" id="idCardStatus">Active Intern</span>
                            </div>
                        </div>
                    </div>
                    <div class="id-card-footer">
                        Â© 2026 Thiranex | thiranex.in
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                <button class="btn" onclick="toggleIDCardModal(false)"
                    style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                    Close
                </button>
                <button class="btn btn-primary" onclick="shareIDCard()"
                    style="box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);">
                    <i class="ph ph-share-network"></i> Share ID Card
                </button>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
    <script>
        const student = DB.getCurrentUser();
        if (!student || student.role !== 'student') window.location.href = 'index.html';

        document.getElementById('userName').innerText = student.name;
        document.getElementById('userDomain').innerText = student.domain;

        function switchTab(tab) {
            const tasksSec = document.getElementById('sectionTasks');
            const paymentSec = document.getElementById('sectionPayment');
            const helpSec = document.getElementById('sectionHelp');
            const btnTasks = document.getElementById('tabTasks');
            const btnPayment = document.getElementById('tabPayment');
            const btnHelp = document.getElementById('tabHelp');

            // Reset all
            tasksSec.style.display = 'none';
            paymentSec.style.display = 'none';
            helpSec.style.display = 'none';
            btnTasks.classList.remove('active');
            btnPayment.classList.remove('active');
            btnHelp.classList.remove('active');

            if (tab === 'tasks') {
                tasksSec.style.display = 'block';
                btnTasks.classList.add('active');
            } else if (tab === 'payment') {
                paymentSec.style.display = 'block';
                btnPayment.classList.add('active');
                renderPaymentStatus();
            } else if (tab === 'help') {
                helpSec.style.display = 'block';
                btnHelp.classList.add('active');
            }
        }

        function renderPaymentStatus() {
            // Refresh student data from DB using the centralized method
            const updatedStudent = DB.getCurrentUser();

            if (updatedStudent) {
                // --- Offer Letter Logic ---
                const offerLink = document.getElementById('offerLink');
                offerLink.className = 'btn doc-btn'; // Preserve class

                if (updatedStudent.offerLetterUrl) {
                    offerLink.href = updatedStudent.offerLetterUrl;
                    offerLink.style.background = 'white';
                    offerLink.style.color = '#10B981';
                    offerLink.style.border = '1px solid #10B981';
                    offerLink.style.cursor = 'pointer';
                    offerLink.style.opacity = '1';
                    offerLink.innerHTML = '<i class="ph ph-download-simple"></i> Offer Letter';
                    offerLink.onclick = null;
                } else {
                    offerLink.removeAttribute('href');
                    offerLink.style.background = '#F3F4F6';
                    offerLink.style.color = '#9CA3AF';
                    offerLink.style.border = '1px solid #E5E7EB';
                    offerLink.style.cursor = 'help';
                    offerLink.title = 'Please wait 24hrs for admin update';
                    offerLink.innerHTML = '<i class="ph ph-clock"></i> Offer Pending';
                    offerLink.onclick = (e) => { e.preventDefault(); alert('Your offer letter is being processed. Please check back in 24 hours.'); };
                }

                // --- Certificate Logic ---
                const certLink = document.getElementById('certLink');
                certLink.className = 'btn doc-btn'; // Preserve class

                if (updatedStudent.certificateUrl) {
                    certLink.href = updatedStudent.certificateUrl;
                    certLink.style.background = 'white';
                    certLink.style.color = '#3B82F6';
                    certLink.style.border = '1px solid #3B82F6';
                    certLink.style.cursor = 'pointer';
                    certLink.style.opacity = '1';
                    certLink.style.animation = 'none';
                    certLink.innerHTML = '<i class="ph ph-certificate"></i> Certificate';
                    certLink.onclick = null;
                } else {
                    certLink.removeAttribute('href');
                    certLink.style.background = '#F3F4F6';
                    certLink.style.color = '#9CA3AF';
                    certLink.style.border = '1px solid #E5E7EB';
                    certLink.style.cursor = 'not-allowed';
                    certLink.style.opacity = '0.8';
                    certLink.innerHTML = '<i class="ph ph-lock-key"></i> Certificate';
                    certLink.onclick = (e) => e.preventDefault();
                }
            }

            const formArea = document.getElementById('paymentFormArea');
            const statusArea = document.getElementById('paymentStatusArea');
            const alertBox = document.getElementById('paymentAlert');

            if (!updatedStudent) return;

            if (updatedStudent.paymentStatus === 'verified') {
                formArea.style.display = 'none';
                if (document.getElementById('qrSection')) document.getElementById('qrSection').style.display = 'none';
                if (document.getElementById('paymentHeader')) document.getElementById('paymentHeader').style.display = 'none';
                document.getElementById('paymentInstructions').style.gridTemplateColumns = '1fr';
                statusArea.style.display = 'block';
                document.getElementById('statusIcon').innerHTML = '<i class="ph-fill ph-check-circle" style="color: var(--success)"></i>';
                document.getElementById('statusTitle').innerText = 'Payment Verified!';
                document.getElementById('statusDesc').innerText = `Your payment of â‚¹${updatedStudent.feeAmount || 0} has been successfully verified. You now have full access to all features.`;
                document.getElementById('verifiedBadge').style.display = 'block';
                alertBox.style.display = 'none';
            } else if (updatedStudent.paymentStatus === 'pending') {
                formArea.style.display = 'none';
                statusArea.style.display = 'block';
                document.getElementById('statusIcon').innerHTML = '<i class="ph ph-clock-countdown" style="color: var(--warning)"></i>';
                document.getElementById('statusTitle').innerText = 'Verification Pending';
                document.getElementById('statusDesc').innerText = `Our admin team is verifying your payment of â‚¹${updatedStudent.feeAmount || 0} (Ref: ${updatedStudent.paymentRef}).`;
                alertBox.style.display = 'block';
            } else {
                formArea.style.display = 'block';
                statusArea.style.display = 'none';
                alertBox.style.display = 'block';

                // Show fee amount in form
                let feeDisplay = document.getElementById('feeDisplay');
                if (!feeDisplay) {
                    feeDisplay = document.createElement('div');
                    feeDisplay.id = 'feeDisplay';
                    feeDisplay.style = "background: var(--primary-light); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary);";
                    formArea.prepend(feeDisplay);
                }
                feeDisplay.innerHTML = `<p style="color: var(--primary-dark); font-weight: 700; font-size: 1.1rem; margin: 0;">Amount to Pay: â‚¹${updatedStudent.feeAmount || 0}</p>`;

                // Update Dynamic QR Logic
                const settings = DB.getSettings();
                const upiID = settings.upiId;
                const name = settings.accountName;
                const amount = (parseFloat(updatedStudent.feeAmount) || 0).toFixed(2);
                const method = settings.preferredMethod || 'upi';

                // Generate Dynamic URL based on method (VPA or Bank Account)
                let upiUrl = '';
                const note = "Internship Payment";
                if (method === 'bank') {
                    // Hidden Bank Account Logic: accountNumber@IFSC.ifsc.npci
                    const bankVPA = `${settings.accountNumber}@${settings.ifsc}.ifsc.npci`;
                    upiUrl = `upi://pay?pa=${bankVPA}&pn=${encodeURIComponent(name)}&am=${amount}&tn=${encodeURIComponent(note)}&cu=INR`;
                } else {
                    upiUrl = `upi://pay?pa=${upiID}&pn=${encodeURIComponent(name)}&am=${amount}&tn=${encodeURIComponent(note)}&cu=INR`;
                }

                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(upiUrl)}`;
                document.getElementById('dynamicQR').src = qrUrl;
            }
        }

        function renderTasks() {
            const tasks = DB.getInternTasks(student.id, student.domain);
            const list = document.getElementById('taskList');
            list.innerHTML = '';

            tasks.forEach((task, index) => {
                const isApproved = task.status === 'approved';
                const isPending = task.status === 'pending';
                const isRejected = task.status === 'rejected';
                // logic: Task is unlocked if it's the first one, OR if the previous one is approved.
                // Special Rule: Task 1 (first domain task) unlocks if Task 0 (mandatory) is submitted (pending) or approved.
                let isLocked = false;
                if (index > 0) {
                    const prevTask = tasks[index - 1];
                    if (index === 1) {
                        // Unlock Task 1 if Task 0 is submitted (pending) or approved
                        if (prevTask.status !== 'approved' && prevTask.status !== 'pending') {
                            isLocked = true;
                        }
                    } else {
                        // Normal tasks require full approval of the previous task
                        if (prevTask.status !== 'approved') {
                            isLocked = true;
                        }
                    }
                }

                const card = document.createElement('div');
                card.className = `card task-card ${isLocked ? 'locked' : ''} ${isApproved ? 'completed' : ''}`;

                let statusBadge = '';
                if (isApproved) statusBadge = '<span class="badge badge-success">Completed</span>';
                else if (isPending) statusBadge = '<span class="badge badge-warning">Reviewing</span>';
                else if (isRejected) statusBadge = '<span class="badge badge-danger">Revision Needed</span>';
                else if (isLocked) statusBadge = '<span class="badge" style="background: #E2E8F0;">Locked</span>';
                else statusBadge = '<span class="badge badge-primary">Available</span>';

                // Safely handle click events by using the index
                const openModalClick = `handleTaskSubmit(${index})`;

                // Custom content for Mandatory Task
                let cardBody = '';
                if (task.isMandatory) {
                    cardBody = `
                        <h3 style="margin-bottom: 0.5rem; color: #0077B5;"><i class="ph-fill ph-linkedin-logo"></i> Mandatory: ${task.title}</h3>
                        <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 1.5rem;">${task.objective}</p>
                        
                        ${!isApproved && !isPending ? `
                            <div style="margin-top: 1rem;">
                                ${task.offerLetterUrl ? `
                                    <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                                        <a href="${task.offerLetterUrl}" target="_blank" class="btn" style="background: #10B981; color: white; justify-content: center; width: 100%;">
                                            <i class="ph ph-download-simple"></i> 1. Download Offer Letter
                                        </a>
                                        <button class="btn btn-primary" style="justify-content: center; width: 100%;" onclick="handleMandatorySubmit()">
                                            <i class="ph ph-linkedin-logo"></i> 2. Submit LinkedIn Post URL
                                        </button>
                                    </div>
                                ` : `
                                    <div style="background: #FFF7ED; padding: 1.2rem; border-radius: 12px; border: 1px solid #FFEDD5; text-align: center;">
                                        <p style="color: #9A3412; font-size: 0.9rem; font-weight: 600; margin-bottom: 0.3rem;">
                                            <i class="ph ph-clock-countdown ph-spin"></i> Preparing Offer Letter
                                        </p>
                                        <p style="color: #C2410C; font-size: 0.8rem;">Our team is generating your official offer letter. Please check back in 24 hours.</p>
                                    </div>
                                `}
                            </div>
                        ` : ''}
                    `;
                } else {
                    cardBody = `
                        <h3 style="margin-bottom: 0.5rem;">${task.title}</h3>
                        <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 1rem;">${task.objective || task.desc || ''}</p>
                        
                        ${task.feature ? `
                            <div style="margin-bottom: 0.5rem;">
                                <small style="font-weight: 600; color: var(--primary);">Key Features:</small>
                                <ul style="font-size: 0.85rem; color: #475569; margin-top: 0.2rem; padding-left: 1.2rem;">
                                    ${String(task.feature).includes('\n') ?
                                String(task.feature).split('\n').map(f => f.trim()).filter(f => f).map(f => `<li style="margin-bottom: 0.2rem;">${f}</li>`).join('') :
                                String(task.feature).split(',').map(f => f.trim()).filter(f => f).map(f => `<li style="margin-bottom: 0.2rem;">${f}</li>`).join('')
                            }
                                </ul>
                            </div>` : ''}
                        ${task.outcome ? `<div style="margin-bottom: 1.5rem;"><small style="font-weight: 600; color: var(--success);">Expected Outcome:</small><p style="font-size: 0.85rem; color: #475569;">${task.outcome}</p></div>` : ''}

                        ${!isLocked && !isApproved && !isPending ? `
                            <div style="display: flex; justify-content: center; margin-top: 1rem;">
                                <button class="btn btn-primary" onclick="${openModalClick}">
                                    Submit Work
                                </button>
                            </div>` : ''}
                    `;
                }

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div style="width: 40px; height: 40px; border-radius: 8px; background: ${isLocked ? '#E2E8F0' : (task.isMandatory ? '#0077B5' : 'var(--primary-light)')}; display: flex; align-items: center; justify-content: center; color: ${isLocked ? '#94A3B8' : (task.isMandatory ? 'white' : 'var(--primary)')}; font-weight: bold; font-size: 1.2rem;">
                            ${task.isMandatory ? '<i class="ph-fill ph-linkedin-logo"></i>' : index}
                        </div>
                        ${statusBadge}
                    </div>
                    ${cardBody}
                    
                    ${isPending ? `<div style="background: var(--primary-light); padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: center;"><p style="font-size: 0.85rem; color: var(--primary-dark); font-weight: 500;"><i class="ph ph-hourglass-high"></i> Under review by admin...</p></div>` : ''}
                    
                    ${isApproved ? `<div style="background: #DCFCE7; padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: center;"><p style="font-size: 0.85rem; color: #166534; font-weight: 600;"><i class="ph ph-check-circle"></i> Completed Successfully!</p></div>` : ''}
                    
                    ${isRejected ? `
                        <div style="margin-top: 1rem;">
                            <div style="background: #FEE2E2; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                                <p style="font-size: 0.85rem; color: #991B1B; font-weight: 500;"><i class="ph ph-warning-circle"></i> Changes requested by mentor.</p>
                            </div>
                            <div style="display: flex; justify-content: center;">
                                <button class="btn" style="background: #991B1B; color: white;" onclick="${openModalClick}">
                                    Resubmit Work
                                </button>
                            </div>
                        </div>` : ''}
                `;

                list.appendChild(card);
            });

            // Update Progress
            const approvedCount = tasks.filter(t => t.status === 'approved').length;
            const progress = (approvedCount / tasks.length) * 100;
            if (document.getElementById('progressBar')) {
                document.getElementById('progressBar').style.width = `${progress}%`;
                document.getElementById('userLevel').innerText = `${Math.round(progress)}%`;
            }

            // Certificate Request Logic
            const updatedStudent = DB.getCurrentUser();
            const certRequested = updatedStudent.certRequestStatus === 'requested';
            const certIssued = updatedStudent.certificateUrl;
            const requestArea = document.getElementById('certificateRequestArea');

            if (approvedCount === tasks.length && !certIssued && tasks.length > 0) {
                requestArea.style.display = 'block';
                if (certRequested) {
                    requestArea.innerHTML = `
                        <div class="card" style="text-align: center; border: 2px solid var(--primary); background: var(--primary-light); display: flex; flex-direction: column; align-items: center; gap: 1rem; padding: 2rem;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                                <i class="ph-fill ph-clock-countdown"></i>
                            </div>
                            <div>
                                <h3 style="color: var(--primary-dark)">Certificate Requested!</h3>
                                <p class="text-muted">You've completed all tasks. Admin will issue your certificate soon.</p>
                            </div>
                        </div>
                    `;
                } else {
                    requestArea.innerHTML = `
                        <div class="card" style="text-align: center; border: 2px dashed var(--primary); padding: 2.5rem; background: white;">
                            <h2 style="color: var(--primary); margin-bottom: 0.5rem;">Congratulations! ðŸŽ‰</h2>
                            <p class="text-muted" style="margin-bottom: 1.5rem; font-size: 1.1rem;">You have successfully completed all internship tasks. You are now eligible for your completion certificate.</p>
                            <button class="btn btn-primary" style="padding: 1rem 2.5rem; font-size: 1.1rem;" onclick="requestCertificate()">
                                <i class="ph ph-certificate"></i> Request Internship Certificate
                            </button>
                        </div>
                    `;
                }
            } else {
                requestArea.style.display = 'none';
            }

            renderPaymentStatus();
        }

        // New Helper Handlers to prevent syntax errors in onclick attributes
        function handleTaskSubmit(index) {
            const tasks = DB.getInternTasks(student.id, student.domain);
            const task = tasks[index];
            if (task) {
                openSubmitModal(task.id, task.title, task.objective || task.desc || 'Submit your project link for review.');
            }
        }

        function handleMandatorySubmit() {
            const tasks = DB.getInternTasks(student.id, student.domain);
            const task = tasks[0]; // Always first
            if (task) {
                openSubmitModal(task.id, task.title, 'Post your offer letter on LinkedIn, tag Thiranex, and paste the post URL below.');
            }
        }

        function requestCertificate() {
            if (DB.requestCertificate(student.id)) {
                alert('Certificate request submitted successfully!');
                renderTasks();
            }
        }

        function openSubmitModal(id, title, objective) {
            document.getElementById('modalTaskId').value = id;
            document.getElementById('modalTaskTitle').innerText = title;
            document.getElementById('modalTaskDesc').innerText = objective;
            document.getElementById('submitModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('submitModal').style.display = 'none'; }

        document.getElementById('submitTaskForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const taskId = document.getElementById('modalTaskId').value;
            const proof = document.getElementById('taskProof').value;

            DB.submitTask(student.id, taskId, proof);
            alert('Task submitted successfully! The admin will review it soon.');
            closeModal();
            renderTasks();
            renderPaymentStatus();
        });

        document.getElementById('paymentForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const refId = document.getElementById('payRef').value;
            DB.submitPayment(student.id, refId);
            alert('Payment reference submitted! Admin will verify it soon.');
            renderPaymentStatus();
        });

        // Toggle Mobile Menu
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const backdrop = document.getElementById('menuBackdrop');
            menu.classList.toggle('active');
            backdrop.style.display = menu.classList.contains('active') ? 'block' : 'none';
        }

        function formatBatchDate(dateStr) {
            if (!dateStr) return '';
            if (dateStr.includes('T') || dateStr.includes('-')) {
                const d = new Date(dateStr);
                if (!isNaN(d.getTime())) {
                    return d.toLocaleString('default', { month: 'short', year: 'numeric' });
                }
            }
            return dateStr;
        }

        // Profile Modal Logic
        function openProfileModal() {
            const current = DB.getCurrentUser();
            document.getElementById('pInternId').value = current.id || 'N/A';
            document.getElementById('pBatch').value = formatBatchDate(current.batch) || 'N/A';
            document.getElementById('pName').value = current.name || '';
            document.getElementById('pCollege').value = current.college || '';
            document.getElementById('pSkills').value = current.skills || '';
            document.getElementById('profileModal').style.display = 'flex';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        document.getElementById('profileForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const updatedData = {
                name: document.getElementById('pName').value,
                college: document.getElementById('pCollege').value,
                skills: document.getElementById('pSkills').value
            };

            if (DB.updateIntern(student.id, updatedData)) {
                alert('Profile updated successfully!');
                closeProfileModal();
                const refreshed = DB.getCurrentUser();
                document.getElementById('userName').innerText = refreshed.name;
                Object.assign(student, refreshed);
            }
        });

        // ID Card Logic
        function toggleIDCardModal(show) {
            const modal = document.getElementById('idCardModal');
            if (show) {
                const current = DB.getCurrentUser();
                document.getElementById('idCardName').innerText = current.name || 'N/A';
                document.getElementById('idCardDomain').innerText = current.domain || 'N/A';
                document.getElementById('idCardInternId').innerText = current.id || 'N/A';
                document.getElementById('idCardBatch').innerText = formatBatchDate(current.batch) || 'N/A';
                document.getElementById('idAvatar').innerText = (current.name || 'A').charAt(0).toUpperCase();

                const statusValue = document.getElementById('idCardStatus');
                if (current.certificateUrl) {
                    statusValue.innerText = 'Certified Graduate';
                    statusValue.style.color = 'var(--success)';
                } else if (current.status === 'dropped') {
                    statusValue.innerText = 'Inactive';
                    statusValue.style.color = 'var(--danger)';
                } else {
                    statusValue.innerText = 'Active Intern';
                    statusValue.style.color = '#10B981';
                }

                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }

        function shareIDCard() {
            if (navigator.share) {
                navigator.share({
                    title: 'My Thiranex Internship ID Card',
                    text: `I'm officially an intern at Thiranex in the ${student.domain} domain! ðŸš€`,
                    url: window.location.href
                }).catch(err => console.log('Error sharing', err));
            } else {
                alert('Success! To share your professional ID card, please take a screenshot or save the professional ID view above. You can post this on LinkedIn to share your achievement!');
            }
        }

        (async function initApp() {
            // Show loading state
            const loader = document.createElement('div');
            loader.innerHTML = '<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);z-index:9999;display:flex;justify-content:center;align-items:center;"><h3><i class="ph ph-spinner ph-spin"></i> Syncing with Cloud...</h3></div>';
            document.body.appendChild(loader);

            await DB.initialize();

            // Re-fetch user in case updates happened since login
            const freshUser = DB.getCurrentUser();
            if (freshUser) {
                // Update local student object reference
                Object.assign(student, freshUser);
                document.getElementById('userName').innerText = student.name;
                document.getElementById('userDomain').innerText = student.domain;
            }

            renderTasks();
            checkPaymentRequirement(); // Special popup for pending payment
            document.body.removeChild(loader);
        })();

        function checkPaymentRequirement() {
            const current = DB.getCurrentUser();
            if (current && current.paymentStatus !== 'verified') {
                const modal = document.getElementById('paymentReminderModal');
                const title = document.getElementById('reminderTitle');
                const desc = document.getElementById('reminderDesc');

                if (current.paymentStatus === 'pending') {
                    title.innerText = 'Verification Pending';
                    desc.innerText = 'Our team is currently verifying your payment. We will unlock your full dashboard as soon as it is confirmed.';
                } else {
                    title.innerText = 'Complete Your Payment';
                    desc.innerText = 'To access all domain tasks and receive your certificate, please complete the internship fee payment.';
                }

                modal.style.display = 'flex';
            }
        }

        function closePaymentReminder() {
            document.getElementById('paymentReminderModal').style.display = 'none';
        }

        function goToPayment() {
            closePaymentReminder();
            switchTab('payment');
        }
    </script>
</body>

</html>