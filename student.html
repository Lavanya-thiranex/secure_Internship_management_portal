<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard | Intern Portal</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        .doc-buttons {
            display: flex;
            flex-direction: row;
            gap: 0.8rem;
            justify-content: flex-end;
            align-items: center;
            margin-top: 1.2rem;
        }

        .doc-btn {
            font-size: 0.95rem !important;
            padding: 0.7rem 1.2rem !important;
            min-width: 160px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .doc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-stats {
            text-align: right;
        }

        @media (max-width: 768px) {
            .level-header {
                flex-direction: column;
                text-align: center;
                gap: 2rem;
                padding: 1.5rem !important;
            }

            .header-stats {
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
            }

            .doc-buttons {
                justify-content: center;
                width: 100%;
                flex-wrap: wrap;
            }

            #userName {
                font-size: 1.8rem;
            }
        }
    </style>
</head>

<body style="padding-bottom: 5rem;">

    <nav
        style="background: white; padding: 1rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100;">
        <div style="display: flex; align-items: center;">
            <img src="logo.png" alt="Thiranex" style="height: 60px; object-fit: contain;">
        </div>

        <!-- Desktop Nav -->
        <div class="nav-links-desktop" style="display: flex; gap: 1rem; align-items: center;">
            <button class="nav-btn active" id="tabTasks" onclick="switchTab('tasks')">
                <i class="ph ph-list-checks"></i> Tasks
            </button>
            <button class="nav-btn" id="tabPayment" onclick="switchTab('payment')">
                <i class="ph ph-receipt"></i> Payment
            </button>
            <button class="nav-btn" onclick="openProfileModal()">
                <i class="ph ph-user-circle"></i> Profile
            </button>
            <button class="btn" style="background: var(--bg-app); color: var(--text-main);" onclick="DB.logout()">
                <i class="ph ph-sign-out"></i> Logout
            </button>
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
            <i class="ph ph-list"></i>
        </button>
    </nav>

    <!-- Mobile Nav Overlay -->
    <div class="mobile-nav-backdrop" id="menuBackdrop" onclick="toggleMobileMenu()"></div>
    <div class="mobile-nav-overlay" id="mobileMenu">
        <div style="display: flex; justify-content: center; margin-bottom: 2.5rem;">
            <img src="logo.png" alt="Thiranex" style="height: 55px; object-fit: contain;">
        </div>
        <button class="btn" style="justify-content: flex-start; background: transparent;"
            onclick="switchTab('tasks'); toggleMobileMenu();">
            <i class="ph ph-list-checks"></i> Tasks
        </button>
        <button class="btn" style="justify-content: flex-start; background: transparent;"
            onclick="switchTab('payment'); toggleMobileMenu();">
            <i class="ph ph-receipt"></i> Payment
        </button>
        <button class="btn" style="justify-content: flex-start; background: transparent;"
            onclick="openProfileModal(); toggleMobileMenu();">
            <i class="ph ph-user-circle"></i> Profile
        </button>
        <hr style="border: none; border-top: 1px solid var(--border);">
        <button class="btn" style="justify-content: flex-start; background: #FEE2E2; color: #991B1B;"
            onclick="DB.logout()">
            <i class="ph ph-sign-out"></i> Logout
        </button>
    </div>

    <div class="container">
        <!-- Dashboard Section -->
        <div id="sectionTasks">
            <!-- Gamified Header -->
            <div class="level-header">
                <div>
                    <p style="text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; color: #94A3B8;">
                        Welcome
                        Intern</p>
                    <h1 id="userName">Loading...</h1>
                    <p id="userDomain" class="badge badge-primary" style="margin-top: 0.5rem;"></p>
                </div>
                <div class="header-stats">
                    <div class="xp-circle" id="userLevel">0%</div>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">Internship Progress</p>
                    <div class="doc-buttons">
                        <!-- Offer Letter Button -->
                        <a id="offerLink" href="#" target="_blank" class="btn doc-btn">
                            Loading...
                        </a>

                        <!-- Certificate Button -->
                        <a id="certLink" href="#" target="_blank" class="btn doc-btn">
                            Loading...
                        </a>
                    </div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
            </div>

            <div style="margin: 2rem 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>Your Journey Tasks</h2>
                    <div id="paymentAlert" style="display: none;">
                        <span class="badge badge-warning" onclick="switchTab('payment')" style="cursor: pointer;">
                            <i class="ph ph-warning-circle"></i> Payment Pending
                        </span>
                    </div>
                </div>
                <div id="certificateRequestArea" style="margin-bottom: 2rem; display: none;"></div>
                <div id="taskList"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">
                    <!-- Tasks will be injected here -->
                </div>
            </div>
        </div>

        <!-- Payment Section -->
        <div id="sectionPayment" style="display: none;">
            <div class="card" style="max-width: 800px; margin: 0 auto; padding: 3rem; text-align: center;">
                <div id="paymentHeader" style="margin-bottom: 2rem;">
                    <h1 style="font-size: 2rem; margin-bottom: 1rem;">Complete Your Enrollment</h1>
                    <p style="color: var(--text-muted);">Please complete the payment to ensure your certificate and
                        internship access are secured.</p>
                </div>

                <div id="paymentInstructions"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: center; text-align: left;">
                    <div id="qrSection">
                        <div
                            style="background: white; padding: 1rem; border-radius: var(--radius-lg); border: 2px dashed var(--primary); display: inline-block;">
                            <img id="dynamicQR" src="qr_code.png" alt="Payment QR Code"
                                style="width: 250px; height: 250px; display: block;">
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted); text-align: center;">
                            <i class="ph ph-scan"></i> Scan this QR using any UPI app
                        </p>
                    </div>
                </div>

                <div id="paymentFormArea">
                    <h3 style="margin-bottom: 1.5rem;">Submit Payment Details</h3>
                    <form id="paymentForm">
                        <div class="form-group">
                            <label>Payment Reference ID (UTR / Transaction ID)</label>
                            <input type="text" id="payRef" class="form-input" placeholder="e.g. 412384759601" required>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Enter the
                                12-digit transaction ID from your UPI app.</p>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                            <i class="ph ph-paper-plane-tilt"></i> Submit Reference ID
                        </button>
                    </form>
                </div>

                <div id="paymentStatusArea"
                    style="display: none; grid-column: span 2; text-align: center; padding: 2rem;">
                    <div id="statusIcon" style="font-size: 4rem; color: var(--warning); margin-bottom: 1rem;">
                        <i class="ph ph-clock-countdown"></i>
                    </div>
                    <h2 id="statusTitle">Verification in Progress</h2>
                    <p id="statusDesc" style="color: var(--text-muted); margin-top: 0.5rem;">
                        Our admin team is verifying your payment (Ref: <span id="displayPayRef"></span>).
                        You will receive a notification once verified.
                    </p>
                    <div id="verifiedBadge" style="display: none; margin-top: 1.5rem;">
                        <span class="badge badge-success" style="font-size: 1rem; padding: 0.5rem 1.5rem;">
                            <i class="ph ph-check-circle"></i> VERIFIED
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Submit Modal -->
    <div id="submitModal" class="modal-overlay">
        <div class="modal">
            <h2 id="modalTaskTitle">Submit Task</h2>
            <p id="modalTaskDesc" style="color: var(--text-muted); margin-top: 0.5rem;"></p>

            <form id="submitTaskForm" style="margin-top: 1.5rem;">
                <input type="hidden" id="modalTaskId">
                <div class="form-group">
                    <label>Submission Link (GitHub, Drive, or URL)</label>
                    <input type="url" id="taskProof" class="form-input" placeholder="https://github.com/your-work"
                        required>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit for Review</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Update Modal -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal">
            <h2>Update Profile</h2>
            <p style="color: var(--text-muted); margin-top: 0.5rem;">Update your personal and educational details.
            </p>

            <form id="profileForm" style="margin-top: 1.5rem;">
                <div class="form-row" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label>Intern ID</label>
                        <input type="text" id="pInternId" class="form-input" readonly
                            style="background: #f1f5f9; cursor: not-allowed; color: var(--text-muted);">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Batch</label>
                        <input type="text" id="pBatch" class="form-input" readonly
                            style="background: #f1f5f9; cursor: not-allowed; color: var(--text-muted);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="pName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>College Name</label>
                    <input type="text" id="pCollege" class="form-input" placeholder="Enter your college name">
                </div>
                <div class="form-group">
                    <label>Skills (Comma separated)</label>
                    <input type="text" id="pSkills" class="form-input" placeholder="e.g. Java, Python, Figma">
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" class="btn" onclick="closeProfileModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script src="db.js"></script>
    <script>
        const student = DB.getCurrentUser();
        if (!student || student.role !== 'student') window.location.href = 'index.html';

        document.getElementById('userName').innerText = student.name;
        document.getElementById('userDomain').innerText = student.domain;

        function switchTab(tab) {
            const tasksSec = document.getElementById('sectionTasks');
            const paymentSec = document.getElementById('sectionPayment');
            const btnTasks = document.getElementById('tabTasks');
            const btnPayment = document.getElementById('tabPayment');

            if (tab === 'tasks') {
                tasksSec.style.display = 'block';
                paymentSec.style.display = 'none';
                btnTasks.classList.add('active');
                btnPayment.classList.remove('active');
            } else {
                tasksSec.style.display = 'none';
                paymentSec.style.display = 'block';
                btnTasks.classList.remove('active');
                btnPayment.classList.add('active');
                renderPaymentStatus();
            }
        }

        function renderPaymentStatus() {
            // Refresh student data from DB using the centralized method
            const updatedStudent = DB.getCurrentUser();

            if (updatedStudent) {
                // --- Offer Letter Logic ---
                const offerLink = document.getElementById('offerLink');
                offerLink.className = 'btn doc-btn'; // Preserve class

                if (updatedStudent.offerLetterUrl) {
                    offerLink.href = updatedStudent.offerLetterUrl;
                    offerLink.style.background = 'white';
                    offerLink.style.color = '#10B981';
                    offerLink.style.border = '1px solid #10B981';
                    offerLink.style.cursor = 'pointer';
                    offerLink.style.opacity = '1';
                    offerLink.innerHTML = '<i class="ph ph-download-simple"></i> Offer Letter';
                    offerLink.onclick = null;
                } else {
                    offerLink.removeAttribute('href');
                    offerLink.style.background = '#F3F4F6';
                    offerLink.style.color = '#9CA3AF';
                    offerLink.style.border = '1px solid #E5E7EB';
                    offerLink.style.cursor = 'help';
                    offerLink.title = 'Please wait 24hrs for admin update';
                    offerLink.innerHTML = '<i class="ph ph-clock"></i> Offer Pending';
                    offerLink.onclick = (e) => { e.preventDefault(); alert('Your offer letter is being processed. Please check back in 24 hours.'); };
                }

                // --- Certificate Logic ---
                const certLink = document.getElementById('certLink');
                certLink.className = 'btn doc-btn'; // Preserve class

                if (updatedStudent.certificateUrl) {
                    certLink.href = updatedStudent.certificateUrl;
                    certLink.style.background = 'white';
                    certLink.style.color = '#3B82F6';
                    certLink.style.border = '1px solid #3B82F6';
                    certLink.style.cursor = 'pointer';
                    certLink.style.opacity = '1';
                    certLink.style.animation = 'none';
                    certLink.innerHTML = '<i class="ph ph-certificate"></i> Certificate';
                    certLink.onclick = null;
                } else {
                    certLink.removeAttribute('href');
                    certLink.style.background = '#F3F4F6';
                    certLink.style.color = '#9CA3AF';
                    certLink.style.border = '1px solid #E5E7EB';
                    certLink.style.cursor = 'not-allowed';
                    certLink.style.opacity = '0.8';
                    certLink.innerHTML = '<i class="ph ph-lock-key"></i> Certificate';
                    certLink.onclick = (e) => e.preventDefault();
                }
            }

            const formArea = document.getElementById('paymentFormArea');
            const statusArea = document.getElementById('paymentStatusArea');
            const alertBox = document.getElementById('paymentAlert');

            if (!updatedStudent) return;

            if (updatedStudent.paymentStatus === 'verified') {
                formArea.style.display = 'none';
                if (document.getElementById('qrSection')) document.getElementById('qrSection').style.display = 'none';
                if (document.getElementById('paymentHeader')) document.getElementById('paymentHeader').style.display = 'none';
                document.getElementById('paymentInstructions').style.gridTemplateColumns = '1fr';
                statusArea.style.display = 'block';
                document.getElementById('statusIcon').innerHTML = '<i class="ph-fill ph-check-circle" style="color: var(--success)"></i>';
                document.getElementById('statusTitle').innerText = 'Payment Verified!';
                document.getElementById('statusDesc').innerText = `Your payment of â‚¹${updatedStudent.feeAmount || 0} has been successfully verified. You now have full access to all features.`;
                document.getElementById('verifiedBadge').style.display = 'block';
                alertBox.style.display = 'none';
            } else if (updatedStudent.paymentStatus === 'pending') {
                formArea.style.display = 'none';
                statusArea.style.display = 'block';
                document.getElementById('statusIcon').innerHTML = '<i class="ph ph-clock-countdown" style="color: var(--warning)"></i>';
                document.getElementById('statusTitle').innerText = 'Verification Pending';
                document.getElementById('statusDesc').innerText = `Our admin team is verifying your payment of â‚¹${updatedStudent.feeAmount || 0} (Ref: ${updatedStudent.paymentRef}).`;
                alertBox.style.display = 'block';
            } else {
                formArea.style.display = 'block';
                statusArea.style.display = 'none';
                alertBox.style.display = 'block';

                // Show fee amount in form
                let feeDisplay = document.getElementById('feeDisplay');
                if (!feeDisplay) {
                    feeDisplay = document.createElement('div');
                    feeDisplay.id = 'feeDisplay';
                    feeDisplay.style = "background: var(--primary-light); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary);";
                    formArea.prepend(feeDisplay);
                }
                feeDisplay.innerHTML = `<p style="color: var(--primary-dark); font-weight: 700; font-size: 1.1rem; margin: 0;">Amount to Pay: â‚¹${updatedStudent.feeAmount || 0}</p>`;

                // Update Dynamic QR Logic
                const settings = DB.getSettings();
                const upiID = settings.upiId;
                const name = settings.accountName;
                const amount = (parseFloat(updatedStudent.feeAmount) || 0).toFixed(2);
                const method = settings.preferredMethod || 'upi';

                // Generate Dynamic URL based on method (VPA or Bank Account)
                let upiUrl = '';
                const note = "Internship Payment";
                if (method === 'bank') {
                    // Hidden Bank Account Logic: accountNumber@IFSC.ifsc.npci
                    const bankVPA = `${settings.accountNumber}@${settings.ifsc}.ifsc.npci`;
                    upiUrl = `upi://pay?pa=${bankVPA}&pn=${encodeURIComponent(name)}&am=${amount}&tn=${encodeURIComponent(note)}&cu=INR`;
                } else {
                    upiUrl = `upi://pay?pa=${upiID}&pn=${encodeURIComponent(name)}&am=${amount}&tn=${encodeURIComponent(note)}&cu=INR`;
                }

                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(upiUrl)}`;
                document.getElementById('dynamicQR').src = qrUrl;
            }
        }

        function renderTasks() {
            const tasks = DB.getInternTasks(student.id, student.domain);
            const list = document.getElementById('taskList');
            list.innerHTML = '';

            let firstLockedFound = false;

            tasks.forEach((task, index) => {
                const isApproved = task.status === 'approved';
                const isPending = task.status === 'pending';
                const isRejected = task.status === 'rejected';

                // logic: Task is unlocked if it's the first one, OR if the previous one is approved.
                let isLocked = false;
                if (index > 0) {
                    const prevTask = tasks[index - 1];
                    if (prevTask.status !== 'approved') {
                        isLocked = true;
                    }
                }

                const card = document.createElement('div');
                card.className = `card task-card ${isLocked ? 'locked' : ''} ${isApproved ? 'completed' : ''}`;

                let statusBadge = '';
                if (isApproved) statusBadge = '<span class="badge badge-success">Completed</span>';
                else if (isPending) statusBadge = '<span class="badge badge-warning">Reviewing</span>';
                else if (isRejected) statusBadge = '<span class="badge badge-danger">Revision Needed</span>';
                else if (isLocked) statusBadge = '<span class="badge" style="background: #E2E8F0;">Locked</span>';
                else statusBadge = '<span class="badge badge-primary">Available</span>';

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div style="width: 40px; height: 40px; border-radius: 8px; background: ${isLocked ? '#E2E8F0' : 'var(--primary-light)'}; display: flex; align-items: center; justify-content: center; color: ${isLocked ? '#94A3B8' : 'var(--primary)'}; font-weight: bold;">
                            ${index + 1}
                        </div>
                        ${statusBadge}
                    </div>
                    <h3 style="margin-bottom: 0.5rem;">${task.title}</h3>
                    <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 1rem;">${task.objective || task.desc || ''}</p>
                    
                    ${task.feature ? `
                        <div style="margin-bottom: 0.5rem;">
                            <small style="font-weight: 600; color: var(--primary);">Key Features:</small>
                            <ul style="font-size: 0.85rem; color: #475569; margin-top: 0.2rem; padding-left: 1.2rem;">
                                ${String(task.feature).includes('\n') ?
                            String(task.feature).split('\n').map(f => f.trim()).filter(f => f).map(f => `<li style="margin-bottom: 0.2rem;">${f}</li>`).join('') :
                            String(task.feature).split(',').map(f => f.trim()).filter(f => f).map(f => `<li style="margin-bottom: 0.2rem;">${f}</li>`).join('')
                        }
                            </ul>
                        </div>` : ''}
                    ${task.outcome ? `<div style="margin-bottom: 1.5rem;"><small style="font-weight: 600; color: var(--success);">Expected Outcome:</small><p style="font-size: 0.85rem; color: #475569;">${task.outcome}</p></div>` : ''}

                    ${!isLocked && !isApproved && !isPending ? `
                        <div style="display: flex; justify-content: center; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="openSubmitModal(${task.id}, '${task.title.replace(/'/g, "\\'")}', '${(task.objective || task.desc || '').replace(/'/g, "\\'")}')">
                                Submit Work
                            </button>
                        </div>` : ''}
                    
                    ${isPending ? `<p style="font-size: 0.85rem; color: var(--warning); text-align: center;">Waiting for Admin review...</p>` : ''}
                    
                    ${isApproved ? `<p style="font-size: 0.85rem; color: var(--success); text-align: center;">Excellent job! Next one unlocked.</p>` : ''}
                    
                    ${isRejected ? `
                        <div style="display: flex; justify-content: center; margin-top: 1rem;">
                            <button class="btn" style="background: #FEE2E2; color: #991B1B;" onclick="openSubmitModal(${task.id}, '${task.title.replace(/'/g, "\\'")}', '${(task.objective || task.desc || '').replace(/'/g, "\\'")}')">
                                Resubmit Work
                            </button>
                        </div>` : ''}
                `;

                list.appendChild(card);
            });

            // Update Progress
            const approvedCount = tasks.filter(t => t.status === 'approved').length;
            const progress = (approvedCount / tasks.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('userLevel').innerText = `${Math.round(progress)}%`;

            // Certificate Request Logic
            const updatedStudent = DB.getCurrentUser();
            const certRequested = updatedStudent.certRequestStatus === 'requested';
            const certIssued = updatedStudent.certificateUrl;
            const requestArea = document.getElementById('certificateRequestArea');

            if (approvedCount === tasks.length && !certIssued && tasks.length > 0) {
                requestArea.style.display = 'block';
                if (certRequested) {
                    requestArea.innerHTML = `
                        <div class="card" style="text-align: center; border: 2px solid var(--primary); background: var(--primary-light); display: flex; flex-direction: column; align-items: center; gap: 1rem; padding: 2rem;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                                <i class="ph-fill ph-clock-countdown"></i>
                            </div>
                            <div>
                                <h3 style="color: var(--primary-dark)">Certificate Requested!</h3>
                                <p class="text-muted">You've completed all tasks. Admin will issue your certificate soon.</p>
                            </div>
                        </div>
                    `;
                } else {
                    requestArea.innerHTML = `
                        <div class="card" style="text-align: center; border: 2px dashed var(--primary); padding: 2.5rem; background: white;">
                            <h2 style="color: var(--primary); margin-bottom: 0.5rem;">Congratulations! ðŸŽ‰</h2>
                            <p class="text-muted" style="margin-bottom: 1.5rem; font-size: 1.1rem;">You have successfully completed all internship tasks. You are now eligible for your completion certificate.</p>
                            <button class="btn btn-primary" style="padding: 1rem 2.5rem; font-size: 1.1rem;" onclick="requestCertificate()">
                                <i class="ph ph-certificate"></i> Request Internship Certificate
                            </button>
                        </div>
                    `;
                }
            } else {
                requestArea.style.display = 'none';
            }

            renderPaymentStatus();
        }

        function requestCertificate() {
            if (DB.requestCertificate(student.id)) {
                alert('Certificate request submitted successfully!');
                renderTasks();
            }
        }

        function openSubmitModal(id, title, objective) {
            document.getElementById('modalTaskId').value = id;
            document.getElementById('modalTaskTitle').innerText = title;
            document.getElementById('modalTaskDesc').innerText = objective;
            document.getElementById('submitModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('submitModal').style.display = 'none'; }

        document.getElementById('submitTaskForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const taskId = document.getElementById('modalTaskId').value;
            const proof = document.getElementById('taskProof').value;

            DB.submitTask(student.id, taskId, proof);
            alert('Task submitted successfully! The admin will review it soon.');
            closeModal();
            renderTasks();
            renderPaymentStatus();
        });

        document.getElementById('paymentForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const refId = document.getElementById('payRef').value;
            DB.submitPayment(student.id, refId);
            alert('Payment reference submitted! Admin will verify it soon.');
            renderPaymentStatus();
        });

        // Toggle Mobile Menu
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const backdrop = document.getElementById('menuBackdrop');
            menu.classList.toggle('active');
            backdrop.style.display = menu.classList.contains('active') ? 'block' : 'none';
        }

        function formatBatchDate(dateStr) {
            if (!dateStr) return '';
            if (dateStr.includes('T') || dateStr.includes('-')) {
                const d = new Date(dateStr);
                if (!isNaN(d.getTime())) {
                    return d.toLocaleString('default', { month: 'short', year: 'numeric' });
                }
            }
            return dateStr;
        }

        // Profile Modal Logic
        function openProfileModal() {
            const current = DB.getCurrentUser();
            document.getElementById('pInternId').value = current.id || 'N/A';
            document.getElementById('pBatch').value = formatBatchDate(current.batch) || 'N/A';
            document.getElementById('pName').value = current.name || '';
            document.getElementById('pCollege').value = current.college || '';
            document.getElementById('pSkills').value = current.skills || '';
            document.getElementById('profileModal').style.display = 'flex';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        document.getElementById('profileForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const updatedData = {
                name: document.getElementById('pName').value,
                college: document.getElementById('pCollege').value,
                skills: document.getElementById('pSkills').value
            };

            if (DB.updateIntern(student.id, updatedData)) {
                alert('Profile updated successfully!');
                closeProfileModal();
                const refreshed = DB.getCurrentUser();
                document.getElementById('userName').innerText = refreshed.name;
                Object.assign(student, refreshed);
            }
        });

        (async function initApp() {
            // Show loading state
            const loader = document.createElement('div');
            loader.innerHTML = '<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);z-index:9999;display:flex;justify-content:center;align-items:center;"><h3><i class="ph ph-spinner ph-spin"></i> Syncing with Cloud...</h3></div>';
            document.body.appendChild(loader);

            await DB.initialize();

            // Re-fetch user in case updates happened since login
            const freshUser = DB.getCurrentUser();
            if (freshUser) {
                // Update local student object reference
                Object.assign(student, freshUser);
                document.getElementById('userName').innerText = student.name;
                document.getElementById('userDomain').innerText = student.domain;
            }

            renderTasks();
            document.body.removeChild(loader);
        })();
    </script>
</body>

</html>